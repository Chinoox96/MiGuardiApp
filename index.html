<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Guardias 24×48</title>
<meta name="theme-color" content="#0ea5e9"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAIElEQVR4Xu3BAQ0AAADCoPdPbQ43oAAAAAAAAAAAAAAAAL4J3gAAAl0nT5wAAAAASUVORK5CYII="/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel para JSX inline -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
  :root{
    --bg: #0f172a;         /* dark */
    --fg: #e5e7eb;
    --panel:#0b1220;
    --border:#1f2937;
  }
  .theme-light{
    --bg: #ffffff;         /* light */
    --fg: #0f172a;
    --panel:#f1f5f9;
    --border:#cbd5e1;
  }
  html,body,#root{height:100%}
  body{background:var(--bg);color:var(--fg)}
  .panel{background:var(--panel);border:1px solid var(--border)}
  .border-soft{border:1px solid var(--border)}
  ::-webkit-scrollbar{height:8px;width:8px}
  ::-webkit-scrollbar-thumb{background:#334155;border-radius:8px}
  .btn{padding:.5rem .75rem;border-radius:.75rem;transform-origin:center}
  .btn:active{transform:scale(.97)}
  .badge{font-size:10px;padding:2px 6px;border-radius:9999px;background:#1f2937}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:12px;z-index:50}
  .modal-card{background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:16px;width:100%;max-width:560px;padding:16px}
  .auto-wrap{position:relative}
  .auto-list{position:absolute;top:100%;left:0;right:0;z-index:20;background:var(--panel);border:1px solid var(--border);border-radius:12px;max-height:220px;overflow:auto}
  .auto-item{padding:8px 10px;cursor:pointer}
  .auto-item:hover{background:#172033}
  .spacer-40{width:40px}
  .pill{display:inline-block;padding:.15rem .45rem;border-radius:9999px;font-size:.7rem;font-weight:600}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useMemo,useEffect,useRef,useContext,createContext} = React;

/* ========= Utils ========= */
const fmtDay   = new Intl.DateTimeFormat("es-AR", { day:"2-digit" });
const fmtMonth = new Intl.DateTimeFormat("es-AR", { month:"long", year:"numeric" });
const fmtFull  = new Intl.DateTimeFormat("es-AR", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

const ymd = d => { const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); };
const parseYMD = s => { const [Y,m,d]=s.split('-').map(Number); const x=new Date(Y,m-1,d); x.setHours(0,0,0,0); return x; };
const addDays  = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const startOfMonth = d => { const x=new Date(d.getFullYear(), d.getMonth(),1); x.setHours(0,0,0,0); return x; };
const isWeekend = d => [0,6].includes(new Date(d).getDay());
const nowTimeHHMM = () => new Date().toTimeString().slice(0,5);

/* ========= Persistencia ========= */
const LS_KEY = "guardias.pwa.v5";
const IDB_NAME = 'guardias-db';
const IDB_STORE = 'state';
function idbOpen(){ return new Promise((res,rej)=>{ const r=indexedDB.open(IDB_NAME,1); r.onupgradeneeded=()=>r.result.createObjectStore(IDB_STORE); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
async function idbGet(key='singleton'){ try{ const db=await idbOpen(); return await new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readonly'); const st=tx.objectStore(IDB_STORE); const g=st.get(key); g.onsuccess=()=>res(g.result||null); g.onerror=()=>rej(g.error); }); }catch{ return null; } }
async function idbSet(val,key='singleton'){ try{ const db=await idbOpen(); await new Promise((res,rej)=>{ const tx=db.transaction(IDB_STORE,'readwrite'); const st=tx.objectStore(IDB_STORE); const p=st.put(val,key); p.onsuccess=()=>res(); p.onerror=()=>rej(p.error); }); }catch{} }

/* ========= Estado inicial ========= */
function defaultState(){
  return {
    days: {},
    // patrón: type = '24x48' | '2x4' | 'administrativo'
    pattern: { enabled:false, start:"", turno:"B", type:"24x48" },
    colors: {
      recargo: "#eab308",
      art: "#ef4444",
      licencia: "#60a5fa",
      cubro_guardia: "#22c55e",
      me_cubre_guardia: "#14b8a6",
      cubro_recargo: "#f59e0b",
      me_cubre_recargo: "#f97316",
      patternGuardiaBg: "rgba(16,185,129,0.25)",
      selected: "#22c55e",
      today: "#34d399",
      summaryPill: "#334155"
    },
    theme: "dark", // 'dark' | 'light'
    holidays: [],
    notes: [],
    objectSuggestions: []
  };
}

function useStore(){
  const [state,setState] = useState(()=>{ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null") || defaultState(); }catch{ return defaultState(); }});
  useEffect(()=>{ (async()=>{ const from = await idbGet(); if(from){ setState(from); }})(); },[]);
  useEffect(()=>{ localStorage.setItem(LS_KEY, JSON.stringify(state)); idbSet(state); },[state]);
  // aplicar tema
  useEffect(()=>{
    const root = document.documentElement;
    if(state.theme==='light'){ root.classList.add('theme-light'); }
    else { root.classList.remove('theme-light'); }
  }, [state.theme]);
  return [state,setState];
}

/* ========= Modelos ========= */
function emptyDay(key){
  return {
    key,
    pabellon:"",
    poblacion:{ total:"", condenados:"", procesados:"", presentes:"", hospitalizados:"" },
    role:"",
    companeros:"",
    notas:"",
    estado: null,        // recargo | cubro_guardia | me_cubre_guardia | cubro_recargo | me_cubre_recargo | art | licencia
    pago:false,          // 💲 (exclusivo con swap)
    swap:false,          // 🔄
    linkedDate:"",
    linkedType:"",
    movimientos:[],
    poblacionListado:[]
  };
}

/* ========= Cálculos licencia ========= */
function expandLicenseByDates(startStr, endStr){
  const start = parseYMD(startStr), end = parseYMD(endStr);
  const out=[]; for(let d=new Date(start); d<=end; d=addDays(d,1)) out.push(ymd(d)); return out;
}
function expandLicenseByWorkingDays(startStr, count, holidaysSet, skipWeekends=true){
  const out=[]; let d=parseYMD(startStr);
  while(out.length < count){
    const key=ymd(d);
    const weekend = skipWeekends && isWeekend(d);
    const holiday = holidaysSet.has(key);
    if(!(weekend || holiday)) out.push(key);
    d = addDays(d,1);
  }
  return out;
}
function expandLicenseByCalendarDays(startStr, count){
  const out=[]; let d=parseYMD(startStr);
  for(let i=0;i<count;i++) out.push(ymd(addDays(d,i)));
  return out;
}

/* ========= Patrón de guardias ========= */
function makePatternFn(pattern){
  if(!pattern.enabled || !pattern.start) return ()=>false;
  const anchor = parseYMD(pattern.start);
  const startKey = ymd(anchor);
  return (date)=>{
    const dayKey = ymd(date);
    const diff = Math.floor((parseYMD(dayKey) - anchor)/86400000);
    if(pattern.type === '24x48'){
      return (diff % 3 === 0); // 1 on + 2 off
    }
    if(pattern.type === '2x4'){
      // 2 trabajo, 4 franco -> ciclo de 6 días: on en (0,1), off (2..5)
      const m = ((diff % 6)+6)%6;
      return (m===0 || m===1);
    }
    if(pattern.type === 'administrativo'){
      const d = new Date(date).getDay(); // 0..6 Domingo..Sábado
      return d>=1 && d<=5; // lun..vie
    }
    return false;
  };
}

/* ========= Contexto ========= */
const StoreCtx = React.createContext(null);
function useStoreContext(){ return React.useContext(StoreCtx); }

/* ========= App ========= */
function App(){
  const [store,setStore] = useStore();
  const today = new Date();
  const [cursor,setCursor] = useState(new Date(today.getFullYear(), today.getMonth(), 1));
  const [selectedKey,setSelectedKey] = useState(null);
  const [screen,setScreen] = useState('month'); // 'month' | 'day' | 'notes'
  const [quickKey,setQuickKey] = useState(null);
  const [showSettings,setShowSettings] = useState(false);
  const [showLicense,setShowLicense] = useState(null);
  const [installPrompt, setInstallPrompt] = useState(null);

  // PWA install prompt
  useEffect(()=>{
    const handler=(e)=>{ e.preventDefault(); setInstallPrompt(e); };
    window.addEventListener('beforeinstallprompt', handler);
    return ()=> window.removeEventListener('beforeinstallprompt', handler);
  },[]);

  // Celdas y swipe para cambiar mes
  const cells = useMemo(()=>{
    const start = startOfMonth(cursor);
    const startWeekDay = (start.getDay()+6)%7; // Lunes=0
    const first = addDays(start,-startWeekDay);
    return Array.from({length:42},(_,i)=> addDays(first,i));
  },[cursor]);

  const isPatternGuardia = useMemo(()=> makePatternFn(store.pattern), [store.pattern]);

  function dayData(k){ return store.days[k] || emptyDay(k); }
  function saveDay(k,patch){ setStore(s=> ({...s, days:{...s.days, [k]:{...dayData(k), ...patch}} })); }

  function setDayEstado(k, {estado=null, pago=false, swap=false, linkedDate="", linkedType="", notaTexto=""}){
    if(pago && swap){ pago=false; }
    // Guardar nota rápida si vino
    if(notaTexto && notaTexto.trim()){
      setStore(s=> ({...s, notes: [...s.notes, {id:crypto.randomUUID?.()||String(Date.now()), type:'texto', date:k, text:notaTexto.trim()}]}));
    }
    if(swap && linkedDate){
      let tipoEsp = "";
      if(estado==='cubro_guardia') tipoEsp='me_cubre_guardia';
      else if(estado==='me_cubre_guardia') tipoEsp='cubro_guardia';
      else if(estado==='cubro_recargo') tipoEsp='me_cubre_recargo';
      else if(estado==='me_cubre_recargo') tipoEsp='cubro_recargo';
      if(tipoEsp){
        const od = dayData(linkedDate);
        saveDay(linkedDate, { ...od, estado: tipoEsp, pago, swap:true, linkedDate:k, linkedType:estado });
      }
    }
    const d = dayData(k);
    saveDay(k,{ ...d, estado, pago, swap, linkedDate, linkedType });
  }

  // taps & swipes día
  const lastTapRef = useRef(0);
  function onTapDay(d){
    const t=Date.now();
    if(t - lastTapRef.current < 350){ openDay(d); }
    else { setSelectedKey(ymd(d)); }
    lastTapRef.current = t;
  }
  function openDay(d){ const k=ymd(d); setSelectedKey(k); setScreen('day'); }

  // swipe mes
  const swipeStartX = useRef(null);
  const monthWrapRef = useRef(null);
  useEffect(()=>{
    const el = monthWrapRef.current; if(!el) return;
    const onStart = (e)=>{ swipeStartX.current = e.touches[0].clientX; };
    const onEnd = (e)=>{ if(swipeStartX.current==null) return;
      const dx = e.changedTouches[0].clientX - swipeStartX.current;
      if(dx > 60) setCursor(d=> new Date(d.getFullYear(), d.getMonth()-1, 1));     // derecha -> mes anterior
      if(dx < -60) setCursor(d=> new Date(d.getFullYear(), d.getMonth()+1, 1));    // izquierda -> mes siguiente
      swipeStartX.current=null;
    };
    el.addEventListener('touchstart', onStart, {passive:true});
    el.addEventListener('touchend', onEnd, {passive:true});
    return ()=>{ el.removeEventListener('touchstart', onStart); el.removeEventListener('touchend', onEnd); };
  }, [monthWrapRef.current]);

  // Resumen bajo el calendario
  const summary = useMemo(()=>{
    if(!selectedKey) return null;
    const d = dayData(selectedKey);
    const pills = [];
    if(d.estado){
      const mapTxt = {
        recargo:'Recargo', art:'ART', licencia:'Licencia',
        cubro_guardia:'Cubro guardia', me_cubre_guardia:'Me cubre guardia',
        cubro_recargo:'Cubro recargo', me_cubre_recargo:'Me cubre recargo'
      };
      pills.push(mapTxt[d.estado] || d.estado);
    }
    if(d.pago) pills.push('💲');
    if(d.swap) pills.push('🔄');
    const P=d.poblacion||{};
    const smalls = [
      d.pabellon?`Pab: ${d.pabellon}`:null,
      P.total?`Pob: ${P.total}`:null,
      P.condenados?`Cond: ${P.condenados}`:null,
      P.procesados?`Proc: ${P.procesados}`:null,
      d.companeros?`Comp: ${d.companeros}`:null
    ].filter(Boolean);
    return {pills, smalls};
  },[selectedKey, store.days]);

  // botón instalar
  async function onInstall(){
    if(!installPrompt) return;
    installPrompt.prompt();
    try{ await installPrompt.userChoice; }catch{}
    setInstallPrompt(null);
  }

  return (
    <div className="h-full flex flex-col">
      <TopBar
        theme={store.theme}
        onToggleTheme={()=> setStore(s=>({...s, theme: s.theme==='dark'?'light':'dark'}))}
        cursor={cursor}
        onPrev={()=> setCursor(d=> new Date(d.getFullYear(), d.getMonth()-1,1))}
        onNext={()=> setCursor(d=> new Date(d.getFullYear(), d.getMonth()+1,1))}
        onNotes={()=> setScreen('notes')}
        onSettings={()=> setShowSettings(true)}
        canInstall={!!installPrompt}
        onInstall={onInstall}
      />

      {screen==='month' && (
        <>
          <div ref={monthWrapRef} className="flex-1 overflow-y-auto px-2 pb-2">
            <MonthGrid
              cells={cells}
              cursor={cursor}
              selectedKey={selectedKey}
              onTap={onTapDay}
              onOpen={openDay}
              isPattern={d=> isPatternGuardia(d)}
              colors={store.colors}
              getDay={k=>dayData(k)}
              onLong={(d)=> setQuickKey(ymd(d))}
            />
          </div>

          {/* Resumen fijo debajo del calendario */}
          {selectedKey && summary && (
            <div className="px-3 pb-3">
              <div className="panel rounded-xl px-3 py-2 text-sm">
                <div className="flex items-center gap-2 flex-wrap mb-1">
                  <span className="text-xs opacity-70">{selectedKey}</span>
                  {summary.pills.map((t,i)=>(
                    <span key={i} className="pill" style={{backgroundColor: (store.colors.summaryPill || '#334155')}}>{t}</span>
                  ))}
                </div>
                <div className="text-xs opacity-90">{summary.smalls.join(' · ')}</div>
              </div>
            </div>
          )}
        </>
      )}

      {screen==='day' && selectedKey && (
        <DayScreen
          ymdKey={selectedKey}
          data={dayData(selectedKey)}
          setData={(patch)=> saveDay(selectedKey, patch)}
          setEstado={(payload)=> setDayEstado(selectedKey, payload)}
          colors={store.colors}
        />
      )}

      {screen==='notes' && <NotesScreen store={store} setStore={setStore}/>}

      {quickKey && (
        <QuickModal
          ymdKey={quickKey}
          data={dayData(quickKey)}
          colors={store.colors}
          onClose={()=>setQuickKey(null)}
          onPick={(payload)=>{ setQuickKey(null); setDayEstado(quickKey, payload); }}
          onOpenLicencia={()=>{ setQuickKey(null); setShowLicense({date:quickKey}); }}
        />
      )}

      {showSettings && (
        <SettingsModal
          store={store}
          onClose={()=>setShowSettings(false)}
          onSave={setStore}
        />
      )}

      {showLicense && (
        <LicenseModal
          date={showLicense.date}
          holidays={new Set(store.holidays)}
          onClose={()=>setShowLicense(null)}
          onApply={({mode, until, corridos, habiles, excluirFeriados})=>{
            let keys=[];
            if(mode==='rango' && until){
              keys = expandLicenseByDates(showLicense.date, until);
            }else{
              if(corridos>0) keys = keys.concat(expandLicenseByCalendarDays(showLicense.date, Number(corridos)));
              if(habiles>0){
                const add = expandLicenseByWorkingDays(showLicense.date, Number(habiles), new Set(excluirFeriados? store.holidays: []), true);
                keys = keys.concat(add);
              }
            }
            const patchDays={...store.days};
            keys.forEach(k=>{ patchDays[k] = {...(patchDays[k]||emptyDay(k)), estado:'licencia', pago:false, swap:false, linkedDate:"", linkedType:""}; });
            setStore(s=> ({...s, days: patchDays}));
            setShowLicense(null);
          }}
        />
      )}
    </div>
  );
}

/* ===== Topbar ===== */
function TopBar({theme,onToggleTheme,cursor,onPrev,onNext,onNotes,onSettings,canInstall,onInstall}){
  return (
    <header className="px-3 py-2 bg-slate-950 border-b border-soft flex items-center gap-2">
      <button onClick={onPrev} className="btn panel">◀</button>
      <div className="text-lg font-medium flex-1 text-center select-none capitalize">{fmtMonth.format(cursor)}</div>
      <button onClick={onNext} className="btn panel">▶</button>
      {canInstall && <button onClick={onInstall} className="btn bg-emerald-600">Instalar</button>}
      <button onClick={onNotes} className="btn bg-sky-600">Notas</button>
      <button onClick={onSettings} className="btn bg-emerald-600">Ajustes</button>
      <button onClick={onToggleTheme} className="btn panel">{theme==='dark'?'🌙':'☀️'}</button>
    </header>
  );
}

/* ===== Calendario (mes) ===== */
function MonthGrid({cells,cursor,selectedKey,onTap,onOpen,isPattern,colors,getDay,onLong}){
  const todayKey = ymd(new Date());
  const weekdays = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
  return (
    <div className="">
      <div className="grid grid-cols-7 text-center text-xs text-slate-400 mb-1 select-none">
        {weekdays.map(w=> <div key={w} className="py-1">{w}</div>)}
      </div>
      <div className="grid grid-cols-7 gap-1">
        {cells.map((d,i)=>{
          const inMonth = d.getMonth()===cursor.getMonth();
          const k = ymd(d);
          const info = getDay(k);
          const pattern = isPattern(d);
          const isToday = todayKey===k;
          const isSel = selectedKey===k;
          return (
            <MonthCell key={i}
              date={d}
              inMonth={inMonth}
              info={info}
              pattern={pattern}
              isToday={isToday}
              isSel={isSel}
              colors={colors}
              onTap={()=>onTap(d)}
              onOpen={()=>onOpen(d)}
              onLong={()=>onLong?.(d)}
            />
          );
        })}
      </div>
    </div>
  );
}

function MonthCell({date,inMonth,info,pattern,isToday,isSel,colors,onTap,onOpen,onLong}){
  const holdRef = useRef(null);
  const onTouchStart = ()=>{ holdRef.current = setTimeout(()=> onLong?.(), 550); };
  const onTouchEnd   = ()=>{ if(holdRef.current){ clearTimeout(holdRef.current); holdRef.current=null; } };

  let bgClass = inMonth? 'bg-slate-800' : 'bg-slate-800/30';
  const styleObj = {};
  if(pattern && !info?.estado){ styleObj.background = colors.patternGuardiaBg || 'transparent'; }
  if(info?.estado){
    const mapCol = {
      recargo: colors.recargo,
      art: colors.art,
      licencia: colors.licencia,
      cubro_guardia: colors.cubro_guardia,
      me_cubre_guardia: colors.me_cubre_guardia,
      cubro_recargo: colors.cubro_recargo,
      me_cubre_recargo: colors.me_cubre_recargo
    };
    styleObj.background = mapCol[info.estado] || 'transparent';
  }
  if(isSel){ styleObj.outline = '2px solid ' + (colors.selected||'#22c55e'); }
  if(isToday){ styleObj.boxShadow = 'inset 0 0 0 2px ' + (colors.today||'#34d399'); }

  // abreviatura cuando NO es guardia de patrón
  const abbr = info?.estado ? (
    {recargo:'R', art:'ART', licencia:'LIC', cubro_guardia:'CG', me_cubre_guardia:'MG', cubro_recargo:'CR', me_cubre_recargo:'MR'}[info.estado] || ''
  ) : '';

  return (
    <button
      onClick={onTap}
      onDoubleClick={onOpen}
      onTouchStart={onTouchStart}
      onTouchEnd={onTouchEnd}
      onContextMenu={(e)=>{ e.preventDefault(); onLong?.(); }}
      className={'aspect-square rounded-xl p-1 flex flex-col items-start justify-between ' + bgClass}
      style={styleObj || {}}
      aria-label={abbr ? ('Estado: ' + abbr) : 'Día'}
    >
      <div className="text-[11px] opacity-90">{fmtDay.format(date)}</div>
      <div className="w-full flex gap-1 flex-wrap justify-end">
        {abbr && <span className="badge">{abbr}</span>}
        {info?.pago && <span className="badge">💲</span>}
        {info?.swap && <span className="badge">🔄</span>}
      </div>
    </button>
  );
}

/* ===== Quick modal (long press) ===== */
function QuickModal({ymdKey,data,colors,onClose,onPick,onOpenLicencia}){
  const [estado,setEstado]=useState(data.estado||"");
  const [pago,setPago]=useState(!!data.pago);
  const [swap,setSwap]=useState(!!data.swap);
  const [linked,setLinked]=useState(data.linkedDate||"");
  const [nota,setNota]=useState("");

  useEffect(()=>{ if(pago && swap){ setPago(false); } },[pago,swap]);

  function go(kind){
    if(kind==='licencia'|| estado==='licencia'){ onOpenLicencia(); return; }
    onPick({estado: estado||null, pago, swap, linkedDate: swap? linked:"", linkedType:"", notaTexto: (kind==='nota')?nota:""});
  }

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-card" onClick={e=>e.stopPropagation()}>
        <div className="text-sm opacity-80 mb-2">{ymdKey}</div>
        <div className="grid gap-2">
          <select value={estado} onChange={e=>setEstado(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-2 py-2">
            <option value="">(sin estado)</option>
            <option value="recargo">Recargo</option>
            <option value="cubro_guardia">Cubro guardia a…</option>
            <option value="me_cubre_guardia">Me cubre guardia…</option>
            <option value="cubro_recargo">Cubro recargo a…</option>
            <option value="me_cubre_recargo">Me cubre recargo…</option>
            <option value="art">ART Nº…</option>
            <option value="licencia">Licencia…</option>
          </select>
          <label className="text-sm flex items-center gap-2">
            <input type="checkbox" checked={pago} onChange={e=>{ setPago(e.target.checked); if(e.target.checked) setSwap(false); }}/> 💲
          </label>
          <label className="text-sm flex items-center gap-2">
            <input type="checkbox" checked={swap} onChange={e=>{ setSwap(e.target.checked); if(e.target.checked) setPago(false); }}/> 🔄
          </label>
          {swap && (
            <input type="date" value={linked} onChange={e=>setLinked(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
          )}
          <textarea rows="2" placeholder="Agregar nota rápida (opcional)" value={nota} onChange={e=>setNota(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
        </div>
        <div className="mt-3 flex justify-between gap-2">
          <button className="btn bg-sky-700" onClick={()=>go('nota')}>Agregar nota</button>
          <div className="flex gap-2">
            <button className="btn panel" onClick={onClose}>Cerrar</button>
            <button className="btn bg-emerald-600" onClick={()=>go('estado')}>{estado==='licencia'?'Licencia…':'Guardar'}</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ===== Modal Licencia ===== */
function LicenseModal({date,holidays,onClose,onApply}){
  const [mode,setMode]=useState('rango'); // 'rango' | 'calculo'
  const [hasta,setHasta]=useState("");
  const [corridos,setCorridos]=useState("");
  const [habiles,setHabiles]=useState("");
  const [excluirFeriados,setExcluirFeriados]=useState(true);

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-card" onClick={e=>e.stopPropagation()}>
        <div className="text-sm mb-2">Licencia desde <strong>{date}</strong></div>
        <div className="mb-2">
          <label className="mr-3"><input type="radio" name="m" checked={mode==='rango'} onChange={()=>setMode('rango')}/> Por rango</label>
          <label><input type="radio" name="m" checked={mode==='calculo'} onChange={()=>setMode('calculo')}/> Por días</label>
        </div>
        {mode==='rango' ? (
          <div className="grid gap-2">
            <label>Hasta: <input type="date" value={hasta} onChange={e=>setHasta(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/></label>
          </div>
        ) : (
          <div className="grid gap-2">
            <label>Días corridos: <input type="number" min="0" value={corridos} onChange={e=>setCorridos(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/></label>
            <label>Días hábiles: <input type="number" min="0" value={habiles} onChange={e=>setHabiles(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/></label>
            <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={excluirFeriados} onChange={e=>setExcluirFeriados(e.target.checked)}/> Excluir feriados</label>
          </div>
        )}
        <div className="mt-3 flex justify-end gap-2">
          <button className="btn panel" onClick={onClose}>Cancelar</button>
          <button className="btn bg-emerald-600" onClick={()=> onApply({mode, until:hasta, corridos, habiles, excluirFeriados})}>Aplicar</button>
        </div>
      </div>
    </div>
  );
}

/* ===== Vista del Día ===== */
function DayScreen({ymdKey,data,setData,setEstado,colors}){
  const [tab,setTab]=useState("guardia");
  useEffect(()=> setTab("guardia"), [ymdKey]);

  const P = data.poblacion||{};
  const collapsedSummary = [
    data.pabellon?('Pab: '+data.pabellon):'Pab: -',
    'Pob: '+(P.total||'-'),
    'Cond: '+(P.condenados||'-'),
    'Proc: '+(P.procesados||'-')
  ].join(' · ');

  return (
    <div className="flex-1 flex flex-col h-full">
      <div className="px-3 py-2 border-b border-soft bg-slate-950 sticky top-0 z-10">
        <div className="text-base capitalize">{fmtFull.format(parseYMD(ymdKey))}</div>
      </div>

      <div className="flex gap-2 px-3 py-2">
        <button onClick={()=>setTab('guardia')} className={'px-4 py-2 rounded-full text-base ' + (tab==='guardia'?'bg-sky-600':'panel')}>Guardia</button>
        <button onClick={()=>setTab('poblacion')} className={'px-4 py-2 rounded-full text-base ' + (tab==='poblacion'?'bg-sky-600':'panel')}>Población</button>
      </div>

      <div className="px-3">
        <DetailsPanel
          collapsedText={collapsedSummary}
          body={<GuardHeader data={data} setData={setData}/>}
        />
      </div>

      <div className="flex-1 overflow-y-auto p-3">
        {tab==='guardia'
          ? <MovimientosTable data={data} setData={setData}/>
          : <PoblacionTable data={data} setData={setData}/>
        }
      </div>
    </div>
  );
}

/* Panel plegable */
function DetailsPanel({collapsedText, body}){
  const [open,setOpen]=useState(true);
  return (
    <div className="rounded-xl border border-soft overflow-hidden">
      <button className="w-full text-left px-3 py-2 bg-slate-800/60" onClick={()=>setOpen(o=>!o)}>
        {open ? '▼ Ocultar' : '► Mostrar'} — {collapsedText}
      </button>
      {open && <div className="p-3" style={{background:'var(--panel)'}}>{body}</div>}
    </div>
  );
}

/* Header Guardia (inputs compactos) */
function GuardHeader({data,setData}){
  const P = data.poblacion||{};
  const Num = (props)=>(
    <input {...props}
      inputMode="numeric" pattern="[0-9]*" maxLength="3"
      className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-24 text-center"/>
  );
  return (
    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 items-end">
      <label className="text-sm">Pabellón
        <input value={data.pabellon} onChange={e=>setData({pabellon:e.target.value})} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/>
      </label>
      <label className="text-sm">Rol
        <input value={data.role} onChange={e=>setData({role:e.target.value})} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/>
      </label>

      <div className="flex gap-2 flex-wrap">
        <span className="pill" style={{background:'#1f2937'}}>Pob</span><Num value={P.total||""} onChange={e=>setData({poblacion:{...P,total:e.target.value}})}/>
        <span className="pill" style={{background:'#334155'}}>Cond</span><Num value={P.condenados||""} onChange={e=>setData({poblacion:{...P,condenados:e.target.value}})}/>
        <span className="pill" style={{background:'#475569'}}>Proc</span><Num value={P.procesados||""} onChange={e=>setData({poblacion:{...P,procesados:e.target.value}})}/>
        <span className="pill" style={{background:'#64748b'}}>Pres</span><Num value={P.presentes||""} onChange={e=>setData({poblacion:{...P,presentes:e.target.value}})}/>
        <span className="pill" style={{background:'#0ea5e9'}}>Hosp</span><Num value={P.hospitalizados||""} onChange={e=>setData({poblacion:{...P,hospitalizados:e.target.value}})}/>
      </div>

      <label className="text-sm col-span-2">Acompañado por
        <input value={data.companeros} onChange={e=>setData({companeros:e.target.value})} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/>
      </label>
      <label className="text-sm col-span-2">Notas
        <textarea rows="2" value={data.notas} onChange={e=>setData({notas:e.target.value})} className="bg-slate-900 border border-soft rounded-xl px-3 py-2 w-full"/>
      </label>
    </div>
  );
}

/* Novedades + Autocomplete */
function MovimientosTable({data,setData}){
  const rows = data.movimientos || [];
  function add(){ const firstTime = nowTimeHHMM(); setData({ movimientos:[ ...rows, { objeto:"", entrada:firstTime, salida:"", movimiento:"", a_cargo:"" } ]}); }
  function del(i){ const c=[...rows]; c.splice(i,1); setData({movimientos:c}); }
  function setRow(i,patch){ const c=[...rows]; c[i]={...c[i],...patch}; setData({movimientos:c}); }

  return (
    <div>
      <div className="grid grid-cols-5 text-[11px] uppercase tracking-wide text-slate-400 mb-1 px-1">
        <div>Objeto</div><div>Entrada</div><div>Salida</div><div>Movimiento</div><div>A cargo de</div>
      </div>
      <div className="space-y-2">
        {rows.map((r,i)=> (
          <div key={i} className="grid grid-cols-5 gap-1">
            <AutoCompleteCell value={r.objeto} onChange={v=>setRow(i,{objeto:v})}/>
            <input value={r.entrada||""} onChange={e=>setRow(i,{entrada:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm"/>
            <input value={r.salida||""} onChange={e=>setRow(i,{salida:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm"/>
            <input value={r.movimiento||""} onChange={e=>setRow(i,{movimiento:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm"/>
            <div className="flex gap-1">
              <input value={r.a_cargo||""} onChange={e=>setRow(i,{a_cargo:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm flex-1"/>
              <button onClick={()=>del(i)} className="px-2 rounded-lg bg-rose-600">✕</button>
            </div>
          </div>
        ))}
      </div>
      <div className="mt-2 flex justify-end">
        <button onClick={add} className="px-3 py-2 rounded-xl bg-emerald-600">Agregar fila</button>
      </div>
    </div>
  );
}

/* Autocomplete que aprende */
function AutoCompleteCell({value,onChange}){
  const [store,setStore] = useStoreContext();
  const [open,setOpen]=useState(false);
  const [query,setQuery]=useState(value||"");

  const baseDefaults = ['Recuento', 'Servicio médico', 'Apertura', 'Patio', 'Almuerzo', 'Cena', 'Abogado', 'Cambio alojamiento', 'Ingreso', 'Libertad', 'Taller'];
  const suggestions = useMemo(()=>{
    const base = [...new Set([...(store.objectSuggestions||[]), ...baseDefaults])];
    if(!query) return base.slice(0,20);
    const q=query.toLowerCase();
    return base.filter(s=> s.toLowerCase().includes(q)).slice(0,20);
  },[store.objectSuggestions, query]);

  function commit(val){
    onChange(val);
    setQuery(val);
    setOpen(false);
    if(val && !store.objectSuggestions?.includes(val)){
      setStore(s=> ({...s, objectSuggestions: [...(s.objectSuggestions||[]), val].slice(-200)}));
    }
  }

  return (
    <div className="auto-wrap">
      <input
        value={query}
        onChange={e=>{ setQuery(e.target.value); onChange(e.target.value); setOpen(true); }}
        onFocus={()=> setOpen(true)}
        onBlur={()=> setTimeout(()=>setOpen(false), 150)}
        placeholder="Recuento, Servicio médico…"
        className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm w-full"
      />
      {open && suggestions.length>0 && (
        <div className="auto-list">
          {suggestions.map((s,i)=> (
            <div key={i} className="auto-item" onMouseDown={()=>commit(s)}>{s}</div>
          ))}
        </div>
      )}
    </div>
  );
}

/* Población */
function PoblacionTable({data,setData}){
  const rows = data.poblacionListado || [];
  function add(){ setData({ poblacionListado:[ ...rows, { matricula:"", cp:"C", nombre:"" } ]}); }
  function del(i){ const c=[...rows]; c.splice(i,1); setData({poblacionListado:c}); }
  function setRow(i,patch){ const c=[...rows]; c[i]={...c[i],...patch}; setData({poblacionListado:c}); }

  const P = data.poblacion||{};
  const tot = rows.length;
  const condenados = rows.filter(r=>r.cp==='C').length;
  const procesados = rows.filter(r=>r.cp==='P').length;
  const mismatch =
    (P.total && Number(P.total)!==tot) ||
    (P.condenados && Number(P.condenados)!==condenados) ||
    (P.procesados && Number(P.procesados)!==procesados);

  return (
    <div>
      {mismatch && <div className="mb-2 text-xs text-amber-400">Aviso: los totales (Pob/Cond/Proc) no coinciden con el detalle.</div>}
      <div className="grid grid-cols-3 text-[11px] uppercase tracking-wide text-slate-400 mb-1 px-1">
        <div>Matrícula</div><div>C/P</div><div>Apellido y Nombre</div>
      </div>
      <div className="space-y-2">
        {rows.map((r,i)=> (
          <div key={i} className="grid grid-cols-3 gap-1">
            <input value={r.matricula||""} onChange={e=>setRow(i,{matricula:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm"/>
            <select value={r.cp||"C"} onChange={e=>setRow(i,{cp:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm">
              <option value="C">C</option><option value="P">P</option>
            </select>
            <div className="flex gap-1">
              <input value={r.nombre||""} onChange={e=>setRow(i,{nombre:e.target.value})} className="bg-slate-900 border border-soft rounded-lg px-2 py-2 text-sm flex-1"/>
              <button onClick={()=>del(i)} className="px-2 rounded-lg bg-rose-600">✕</button>
            </div>
          </div>
        ))}
      </div>
      <div className="mt-2 flex justify-end">
        <button onClick={add} className="px-3 py-2 rounded-xl bg-emerald-600">Agregar interno</button>
      </div>
    </div>
  );
}

/* ===== Ajustes ===== */
function SettingsModal({store,onClose,onSave}){
  const [start,setStart]=useState(store.pattern.start||"");
  const [turno,setTurno]=useState(store.pattern.turno||"B");
  const [type,setType]=useState(store.pattern.type||"24x48");
  const [enabled,setEnabled]=useState(!!store.pattern.enabled);
  const [colors,setColors]=useState(store.colors||{});
  const [holidaysTxt,setHolidaysTxt]=useState((store.holidays||[]).join("\n"));

  function save(){
    const holidays = holidaysTxt.split(/\s+/).map(s=>s.trim()).filter(Boolean);
    onSave(s=> ({...s,
      pattern:{...s.pattern, start, turno, type, enabled},
      colors:{...s.colors, ...colors},
      holidays
    })); onClose();
  }

  // aviso colores repetidos
  const colorKeys = ['recargo','art','licencia','cubro_guardia','me_cubre_guardia','cubro_recargo','me_cubre_recargo'];
  const seen = new Map();
  const duplicated = colorKeys.some(k=>{ const v=colors[k]; if(!v) return false; if(seen.has(v)) return true; seen.set(v,1); return false; });

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-card" onClick={e=>e.stopPropagation()}>
        <h3 className="text-lg font-semibold mb-2">Ajustes</h3>
        <div className="grid gap-3">
          <div className="grid grid-cols-2 gap-2">
            <label className="text-sm">Tipo de patrón</label>
            <select value={type} onChange={e=>setType(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2">
              <option value="24x48">24×48</option>
              <option value="2x4">2×4 (días)</option>
              <option value="administrativo">Administrativo (L–V)</option>
            </select>

            <label className="text-sm">Inicio patrón (día base)</label>
            <input type="date" value={start} onChange={e=>setStart(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>

            <label className="text-sm">Turno</label>
            <select value={turno} onChange={e=>setTurno(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2">
              <option>A</option><option>B</option><option>C</option>
            </select>

            <label className="text-sm">Patrón activo</label>
            <input type="checkbox" checked={enabled} onChange={e=>setEnabled(e.target.checked)}/>
          </div>

          <div className="grid grid-cols-2 gap-2">
            <div className="text-sm opacity-80 col-span-2">Colores por estado (sin repetir):</div>
            {['recargo','art','licencia','cubro_guardia','me_cubre_guardia','cubro_recargo','me_cubre_recargo'].map(key=>(
              <React.Fragment key={key}>
                <label className="text-sm capitalize">{key.replaceAll('_',' ')}</label>
                <input type="color" value={colors[key]} onChange={e=>setColors(c=>({...c,[key]:e.target.value}))}/>
              </React.Fragment>
            ))}
            <label className="text-sm">Fondo patrón guardia</label>
            <input type="text" value={colors.patternGuardiaBg} onChange={e=>setColors(c=>({...c,patternGuardiaBg:e.target.value}))} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
            <label className="text-sm">Borde hoy</label>
            <input type="color" value={colors.today} onChange={e=>setColors(c=>({...c,today:e.target.value}))}/>
            <label className="text-sm">Selección</label>
            <input type="color" value={colors.selected} onChange={e=>setColors(c=>({...c,selected:e.target.value}))}/>
            <label className="text-sm">Píldora de resumen</label>
            <input type="color" value={colors.summaryPill} onChange={e=>setColors(c=>({...c,summaryPill:e.target.value}))}/>
          </div>
          {duplicated && <div className="text-amber-400 text-xs">Aviso: hay colores repetidos entre estados.</div>}

          <div>
            <div className="text-sm mb-1">Feriados (uno por línea, formato YYYY-MM-DD)</div>
            <textarea rows="4" value={holidaysTxt} onChange={e=>setHolidaysTxt(e.target.value)} className="w-full bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
          </div>

          <div className="flex justify-end gap-2">
            <button className="btn panel" onClick={onClose}>Cerrar</button>
            <button className="btn bg-emerald-600" onClick={save}>Guardar</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ===== Notas (sin ART ni LICENCIA) ===== */
function NotesScreen({store,setStore}){
  const [items,setItems] = useState(store.notes||[]);
  const [type,setType] = useState('sueldo'); // sueldo | pago_recargos | aguinaldo | texto
  const [date,setDate] = useState(ymd(new Date()));
  const [text,setText] = useState('');
  useEffect(()=> setItems(store.notes||[]), [store.notes]);
  function add(){ const n=[...items, {type,date,text,id:crypto.randomUUID?.()||String(Date.now())}]; setItems(n); setStore(s=>({...s, notes:n})); }
  function del(id){ const n=items.filter(x=>x.id!==id); setItems(n); setStore(s=>({...s, notes:n})); }
  return (
    <div className="flex-1 overflow-y-auto p-3">
      <div className="grid grid-cols-1 sm:grid-cols-4 gap-2 mb-3">
        <select value={type} onChange={e=>setType(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2">
          <option value="sueldo">Día de paga (sueldo)</option>
          <option value="pago_recargos">Pagos de recargos</option>
          <option value="aguinaldo">Pago aguinaldo</option>
          <option value="texto">Texto a elección</option>
        </select>
        <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
        <input placeholder="Detalle / nº / rango" value={text} onChange={e=>setText(e.target.value)} className="bg-slate-900 border border-soft rounded-xl px-3 py-2"/>
        <button onClick={add} className="px-3 py-2 rounded-xl bg-emerald-600">Agregar</button>
      </div>
      <div className="space-y-2">
        {items.map(it=> (
          <div key={it.id} className="panel rounded-xl p-3 flex items-start gap-2">
            <div className="text-xs px-2 py-1 rounded bg-sky-700 capitalize">{it.type}</div>
            <div className="text-sm flex-1">
              <div className="opacity-80">{it.date}</div>
              <div>{it.text}</div>
            </div>
            <button className="px-2 rounded bg-rose-600" onClick={()=>del(it.id)}>✕</button>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ===== Provider ===== */
const StoreCtx = React.createContext(null);
function useStoreContext(){ return React.useContext(StoreCtx); }
function Root(){
  const storeHook = useStore();
  return (
    <StoreCtx.Provider value={storeHook}>
      <App/>
    </StoreCtx.Provider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>

<script>
// Registrar tu SW físico (sw.js) – déjalo al lado de este index.html
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
