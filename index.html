<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>MiGuardiApp</title>
<meta name="theme-color" content="#0ea5e9"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<style>
  html,body{height:100%;margin:0;background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #root{height:100%;display:flex;flex-direction:column}
  header{padding:8px 12px;background:#0b1220;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:8px}
  .btn{padding:6px 10px;border-radius:10px;background:#1f2937;color:#e5e7eb;border:none;cursor:pointer}
  .btn.primary{background:#0ea5e9}.btn.success{background:#16a34a}.btn.warn{background:#eab308}.btn.danger{background:#dc2626}
  .calendar{flex:1;overflow-y:auto;padding:10px}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;color:#94a3b8;font-size:12px;text-align:center;margin:4px 0 6px}
  .cell{aspect-ratio:1/1;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between;padding:6px;font-size:12px;background:#1f2937}
  .cell.off{opacity:.35}
  .cell.today{box-shadow:inset 0 0 0 2px #34d399}
  .cell.selected{outline:2px solid #22c55e}
  .muted{color:#94a3b8}
  .badge{font-size:10px;padding:2px 6px;border-radius:9999px;background:#374151}
  .panel{border:1px solid #334155;border-radius:12px;overflow:hidden}
  .panel-h{background:#1f2937;padding:10px;cursor:pointer}
  .panel-b{background:#0b1220;padding:10px}
  .tabs{display:flex;gap:8px;padding:8px 12px}
  .tab{padding:8px 14px;border-radius:999px;background:#1f2937}
  .tab.active{background:#0ea5e9}
  input,select,textarea{background:#0b1220;border:1px solid #374151;border-radius:10px;color:#e5e7eb;padding:8px;width:100%}
  label.l{display:flex;flex-direction:column;gap:6px;font-size:14px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #334155;padding:6px;font-size:12px}
  .right{display:flex;justify-content:flex-end}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
  .card{background:#0b1220;border:1px solid #334155;border-radius:16px;max-width:680px;width:100%;max-height:90%;overflow:auto;padding:14px}
  .auto{position:relative}
  .auto-list{position:absolute;top:100%;left:0;right:0;background:#0b1220;border:1px solid #334155;border-radius:10px;max-height:220px;overflow:auto;z-index:20}
  .auto-item{padding:8px;cursor:pointer}
  .auto-item:hover{background:#132036}
</style>
</head>
<body>
<div id="root">
  <header>
    <button id="prev" class="btn">‚óÄ</button>
    <div style="flex:1;text-align:center" id="monthLabel"></div>
    <button id="next" class="btn">‚ñ∂</button>
    <button id="notesBtn" class="btn">üìù</button>
    <button id="settingsBtn" class="btn primary">Ajustes</button>
  </header>
  <div id="summary" style="padding:8px 12px;display:none"></div>
  <div class="calendar" id="calendar"></div>
</div>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
/* =================== Utils =================== */
const {useState,useMemo,useEffect,useRef,useContext,createContext} = React;
const fmtDay=new Intl.DateTimeFormat("es-AR",{day:"2-digit"});
const fmtMonth=new Intl.DateTimeFormat("es-AR",{month:"long",year:"numeric"});
const fmtFull=new Intl.DateTimeFormat("es-AR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"});
const ymd=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x.toISOString().slice(0,10);}
const parseYMD=s=>{const [Y,m,d]=s.split("-").map(Number);const x=new Date(Y,m-1,d);x.setHours(0,0,0,0);return x;}
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}
const startOfMonth=d=>{const x=new Date(d.getFullYear(),d.getMonth(),1);x.setHours(0,0,0,0);return x;}
const nowHHMM=()=>new Date().toTimeString().slice(0,5);
const isWeekend=d=>[0,6].includes(new Date(d).getDay());

/* ============ Persistencia robusta ============ */
const LS_KEY="guardias.pwa.v5";
const IDB_NAME='guardias-db';const IDB_STORE='state';
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(IDB_NAME,1);r.onupgradeneeded=()=>r.result.createObjectStore(IDB_STORE);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)})}
async function idbGet(key='singleton'){try{const db=await idbOpen();return await new Promise((res,rej)=>{const tx=db.transaction(IDB_STORE,'readonly');const st=tx.objectStore(IDB_STORE);const g=st.get(key);g.onsuccess=()=>res(g.result||null);g.onerror=()=>rej(g.error)});}catch{return null}}
async function idbSet(val,key='singleton'){try{const db=await idbOpen();await new Promise((res,rej)=>{const tx=db.transaction(IDB_STORE,'readwrite');const st=tx.objectStore(IDB_STORE);const p=st.put(val,key);p.onsuccess=()=>res();p.onerror=()=>rej(p.error)})}catch{}}

/* ================== Estado base ================= */
function defaultState(){
  return {
    days:{},                               // 'YYYY-MM-DD': Day
    pattern:{enabled:false,start:"",turno:"B"},
    colors:{
      guardia:"#0ea5e9",
      recargo:"#eab308",
      art:"#ef4444",
      licencia:"#60a5fa",
      patternGuardiaBg:"rgba(16,185,129,0.25)",
      selected:"#22c55e",
      today:"#34d399"
    },
    holidays:[],                           // feriados 'YYYY-MM-DD'
    notes:[],                              // notas sueltas
    objectSuggestions:[]                   // aprende para columna "Objeto"
  };
}
function useStore(){
  const [state,setState]=useState(()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||"null")||defaultState()}catch{return defaultState()}});
  useEffect(()=>{(async()=>{const from=await idbGet();if(from){setState(from)}})()},[]);
  useEffect(()=>{localStorage.setItem(LS_KEY,JSON.stringify(state));idbSet(state)},[state]);
  return [state,setState];
}
const StoreCtx=createContext(null);
const useStoreCtx=()=>useContext(StoreCtx);

/* ================ Modelos / helpers ================ */
function emptyDay(key){
  return {
    key,
    pabellon:"",
    poblacion:{total:"",presentes:"",condenados:"",procesados:"",hospitalizados:""},
    role:"",
    companeros:"",
    notas:"",
    // estado exclusivo:
    // 'guardia' | 'recargo' | 'cubro_guardia' | 'me_cubre_guardia' | 'cubro_recargo' | 'me_cubre_recargo' | 'art' | 'licencia'
    estado:null,
    pago:false, swap:false, linkedDate:"", linkedType:"",
    artNumero:"",
    movimientos:[],                         // {objeto,entrada,salida,movimiento,a_cargo}
    poblacionListado:[]                     // {matricula, cp:'C'|'P', nombre}
  };
}
function expandDatesRange(startStr,endStr){
  const out=[]; for(let d=parseYMD(startStr); d<=parseYMD(endStr); d=addDays(d,1)) out.push(ymd(d)); return out;
}
function expandWorkingDays(startStr,count,holidays){
  const out=[]; let d=parseYMD(startStr);
  while(out.length<count){
    const k=ymd(d);
    if(!isWeekend(k) && !holidays.has(k)) out.push(k);
    d=addDays(d,1);
  } return out;
}
function expandCalendarDays(startStr,count){
  const out=[]; for(let i=0;i<count;i++) out.push(ymd(addDays(parseYMD(startStr),i))); return out;
}

/* ==================== App ==================== */
function App(){
  const [store,setStore]=useStore();
  const [cursor,setCursor]=useState(new Date());
  const [selected,setSelected]=useState(null);
  const [screen,setScreen]=useState('month'); // month | day | notes (notas minimal)
  const [quickKey,setQuickKey]=useState(null);
  const [showSettings,setShowSettings]=useState(false);
  const [showLicense,setShowLicense]=useState(null); // {date}

  // celdas del mes
  const cells=useMemo(()=>{
    const start=startOfMonth(cursor);
    const startWeek=(start.getDay()+6)%7;
    const first=addDays(start,-startWeek);
    return Array.from({length:42},(_,i)=>addDays(first,i));
  },[cursor]);

  // patr√≥n 24x48 desde fecha de inicio, infinito
  const isPatternGuardia=useMemo(()=>{
    const p=store.pattern; if(!p.enabled||!p.start) return ()=>false;
    const anchor=parseYMD(p.start);
    return d=>{const diff=Math.floor((parseYMD(ymd(d))-anchor)/86400000);return (diff%3===0);}
  },[store.pattern]);

  const todayKey=ymd(new Date());

  function dayData(k){return store.days[k]||emptyDay(k);}
  function saveDay(k,patch){ setStore(s=>({...s, days:{...s.days, [k]:{...dayData(k), ...patch}}})) }

  // set estado exclusivo (üí≤ XOR üîÑ, swap espejo)
  function setEstado(k,{estado=null,pago=false,swap=false,linkedDate="",artNumero=""}){
    if(pago && swap) pago=false;
    const d=dayData(k);
    // espejo swap
    if(swap && linkedDate){
      let tipoEsp="";
      if(estado==='cubro_guardia') tipoEsp='me_cubre_guardia';
      else if(estado==='me_cubre_guardia') tipoEsp='cubro_guardia';
      else if(estado==='cubro_recargo') tipoEsp='me_cubre_recargo';
      else if(estado==='me_cubre_recargo') tipoEsp='cubro_recargo';
      if(tipoEsp){
        const other=dayData(linkedDate);
        saveDay(linkedDate,{estado:tipoEsp,pago,swap:true,linkedDate:k,linkedType:estado});
      }
    }
    saveDay(k,{estado,pago,swap,linkedDate,artNumero});
  }

  // gestos: 1 tap select; doble tap abre
  const lastTapRef=useRef(0);
  function onTapDay(d){
    const t=Date.now();
    const k=ymd(d);
    if(t - lastTapRef.current < 350){ setSelected(k); setScreen('day'); }
    else { setSelected(k); }
    lastTapRef.current=t;
  }

  // resumen del d√≠a seleccionado
  const summary=useMemo(()=>{
    if(!selected) return "";
    const d=dayData(selected);
    const arr=[];
    if(d.estado) arr.push(String(d.estado).toUpperCase());
    if(d.pabellon) arr.push("Pab: "+d.pabellon);
    const P=d.poblacion||{};
    if(P.total) arr.push("Pob: "+P.total);
    if(P.condenados) arr.push("Cond: "+P.condenados);
    if(P.procesados) arr.push("Proc: "+P.procesados);
    if(d.companeros) arr.push("Comp: "+d.companeros);
    return arr.join(" ¬∑ ");
  },[selected,store.days]);

  useEffect(()=>{
    const el=document.getElementById('summary');
    if(selected && summary){ el.style.display='block'; el.textContent = selected+" ‚Äî "+summary; }
    else { el.style.display='none'; }
    document.getElementById('monthLabel').textContent = fmtMonth.format(cursor);
  },[selected,summary,cursor]);

  // botones header
  useEffect(()=>{
    const prev=()=>setCursor(d=>new Date(d.getFullYear(),d.getMonth()-1,1));
    const next=()=>setCursor(d=>new Date(d.getFullYear(),d.getMonth()+1,1));
    const settings=()=>setShowSettings(true);
    const notes=()=>setScreen('notes');
    const bp=document.getElementById('prev'), bn=document.getElementById('next'), bs=document.getElementById('settingsBtn'), bn2=document.getElementById('notesBtn');
    bp.onclick=prev; bn.onclick=next; bs.onclick=settings; bn2.onclick=notes;
  },[]);

  return (
    <StoreCtx.Provider value={[store,setStore]}>
      <div style={{flex:1,display:'flex',flexDirection:'column'}}>
        {screen==='month' && (
          <div className="calendar">
            <div className="dow">
              {["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"].map(w=><div key={w}>{w}</div>)}
            </div>
            <div className="grid">
              {cells.map((d,i)=>{
                const k=ymd(d);
                const info=dayData(k);
                const inMonth = d.getMonth()===cursor.getMonth();
                const isSel = selected===k;
                const isToday = todayKey===k;
                // color de fondo seg√∫n estado o patr√≥n
                const style={};
                if(info.estado){
                  const map={
                    guardia: store.colors.guardia,
                    recargo: store.colors.recargo,
                    art: store.colors.art,
                    licencia: store.colors.licencia,
                    cubro_guardia: store.colors.guardia,
                    me_cubre_guardia: store.colors.guardia,
                    cubro_recargo: store.colors.recargo,
                    me_cubre_recargo: store.colors.recargo
                  };
                  style.background = map[info.estado] || "#1f2937";
                }else if(isPatternGuardia(d)){
                  style.background = store.colors.patternGuardiaBg;
                }
                if(isSel) style.outline = "2px solid "+store.colors.selected;
                if(isToday) style.boxShadow = "inset 0 0 0 2px "+store.colors.today;

                return (
                  <button key={i}
                    className={"cell"+(inMonth?"":" off")}
                    style={style}
                    onClick={()=>onTapDay(d)}
                    onDoubleClick={()=>{setSelected(k);setScreen('day');}}
                    onContextMenu={(e)=>{e.preventDefault();setQuickKey(k);}}
                    onTouchStart={(e)=>{ // long press
                      const t=setTimeout(()=>setQuickKey(k),550);
                      e.currentTarget._lp=t;
                    }}
                    onTouchEnd={(e)=>{clearTimeout(e.currentTarget._lp)}}
                  >
                    <div>{fmtDay.format(d)}</div>
                    <div style={{display:'flex',gap:'4px',flexWrap:'wrap',justifyContent:'flex-end'}}>
                      {info.pago && <span className="badge">üí≤</span>}
                      {info.swap && <span className="badge">üîÑ</span>}
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {screen==='day' && selected && (
          <DayScreen ymdKey={selected} data={dayData(selected)} save={(p)=>saveDay(selected,p)} />
        )}

        {screen==='notes' && (
          <NotesScreen/>
        )}

        {quickKey && (
          <QuickModal
            ymdKey={quickKey}
            data={dayData(quickKey)}
            onClose={()=>setQuickKey(null)}
            onPick={(payload)=>{ setEstado(quickKey,payload); setQuickKey(null); }}
            onOpenLicencia={()=>{ setQuickKey(null); setShowLicense({date:quickKey}); }}
          />
        )}

        {showLicense && (
          <LicenseModal
            date={showLicense.date}
            holidays={new Set(store.holidays)}
            onClose={()=>setShowLicense(null)}
            onApply={({mode,until,corridos,habiles,excluirFeriados})=>{
              let keys=[];
              if(mode==='rango' && until){ keys = expandDatesRange(showLicense.date, until); }
              else {
                if(corridos>0) keys = keys.concat(expandCalendarDays(showLicense.date, Number(corridos)));
                if(habiles>0){
                  const hs = new Set(excluirFeriados? store.holidays: []);
                  keys = keys.concat(expandWorkingDays(showLicense.date, Number(habiles), hs));
                }
              }
              const patch={...store.days};
              keys.forEach(k=>{ patch[k] = {...(patch[k]||emptyDay(k)), estado:'licencia', pago:false, swap:false, linkedDate:"", linkedType:""}; });
              setStore(s=>({...s, days:patch}));
              setShowLicense(null);
            }}
          />
        )}

        {showSettings && <SettingsModal onClose={()=>setShowSettings(false)} />}
      </div>
    </StoreCtx.Provider>
  );
}

/* ================== Vista D√≠a ================== */
function DayScreen({ymdKey,data,save}){
  const [tab,setTab]=useState('guardia');
  const wrapRef=useRef(null);
  useEffect(()=>setTab('guardia'),[ymdKey]);
  // swipe derecha -> poblaci√≥n
  useEffect(()=>{
    const el=wrapRef.current; if(!el) return;
    let sx=null;
    const ts=e=>{sx=e.touches[0].clientX;}
    const te=e=>{ if(sx==null) return; const dx=e.changedTouches[0].clientX-sx; if(dx>60) setTab('poblacion'); sx=null; }
    el.addEventListener('touchstart',ts,{passive:true}); el.addEventListener('touchend',te,{passive:true});
    return ()=>{el.removeEventListener('touchstart',ts); el.removeEventListener('touchend',te);}
  },[wrapRef.current]);

  const P=data.poblacion||{};
  const collapsed = ["Pab: "+(data.pabellon||"-"), "Pob: "+(P.total||"-"), "Cond: "+(P.condenados||"-"), "Proc: "+(P.procesados||"-")].join(" ¬∑ ");

  return (
    <div ref={wrapRef} style={{flex:1,display:'flex',flexDirection:'column'}}>
      <div style={{padding:'8px 12px',borderBottom:'1px solid #1f2937',background:'#0b1220',position:'sticky',top:0,zIndex:5}}>
        <div style={{fontWeight:600}}>{fmtFull.format(parseYMD(ymdKey))}</div>
      </div>

      <div className="tabs">
        <button className={"tab "+(tab==='guardia'?'active':'')} onClick={()=>setTab('guardia')}>Guardia</button>
        <button className={"tab "+(tab==='poblacion'?'active':'')} onClick={()=>setTab('poblacion')}>Poblaci√≥n</button>
      </div>

      <div style={{padding:'0 12px'}}>
        <Collapsible headerText={"‚ñº Datos ‚Äî "+collapsed}>
          <GuardHeader data={data} save={save}/>
        </Collapsible>
      </div>

      <div style={{flex:1,overflow:'auto',padding:'12px'}}>
        {tab==='guardia' ? <Movimientos data={data} save={save}/> : <Poblacion data={data} save={save}/>}
      </div>
    </div>
  );
}

function Collapsible({headerText,children}){
  const [open,setOpen]=useState(true);
  return (
    <div className="panel">
      <div className="panel-h" onClick={()=>setOpen(v=>!v)}>{open?headerText.replace("‚ñº","‚ñ∫"):headerText}</div>
      {open && <div className="panel-b">{children}</div>}
    </div>
  );
}

function GuardHeader({data,save}){
  const P=data.poblacion||{};
  return (
    <div style={{display:'grid',gap:'10px',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))'}}>
      <label className="l">Pabell√≥n<input value={data.pabellon||""} onChange={e=>save({pabellon:e.target.value})}/></label>
      <label className="l">Poblaci√≥n total<input type="number" value={P.total||""} onChange={e=>save({poblacion:{...P,total:e.target.value}})}/></label>
      <label className="l">Presentes<input type="number" value={P.presentes||""} onChange={e=>save({poblacion:{...P,presentes:e.target.value}})}/></label>
      <label className="l">Condenados<input type="number" value={P.condenados||""} onChange={e=>save({poblacion:{...P,condenados:e.target.value}})}/></label>
      <label className="l">Procesados<input type="number" value={P.procesados||""} onChange={e=>save({poblacion:{...P,procesados:e.target.value}})}/></label>
      <label className="l">Hospitalizados<input type="number" value={P.hospitalizados||""} onChange={e=>save({poblacion:{...P,hospitalizados:e.target.value}})}/></label>
      <label className="l">Rol (Celador/Auxiliar)<input value={data.role||""} onChange={e=>save({role:e.target.value})}/></label>
      <label className="l">Acompa√±ado por (coma separada)<input value={data.companeros||""} onChange={e=>save({companeros:e.target.value})}/></label>
      <label className="l">Notas<textarea rows="3" value={data.notas||""} onChange={e=>save({notas:e.target.value})}></textarea></label>
    </div>
  );
}

/* ======= Autocomplete que aprende ======= */
function AutoObjeto({value,onChange}){
  const [store,setStore]=useStoreCtx();
  const [open,setOpen]=useState(false);
  const [q,setQ]=useState(value||"");
  const list=useMemo(()=>{
    const base=store.objectSuggestions||[];
    if(!q) return base.slice(-200).slice().reverse(); // √∫ltimas primero
    const qq=q.toLowerCase();
    return base.filter(s=>s.toLowerCase().includes(qq)).slice(-200).reverse();
  },[store.objectSuggestions,q]);
  function commit(v){
    onChange(v); setQ(v); setOpen(false);
    if(v && !store.objectSuggestions?.includes(v)){
      setStore(s=>({...s, objectSuggestions:[...(s.objectSuggestions||[]), v].slice(-300)}));
    }
  }
  return (
    <div className="auto">
      <input value={q} placeholder="Recuento, Servicio m√©dico, Apertura‚Ä¶"
        onFocus={()=>setOpen(true)}
        onBlur={()=>setTimeout(()=>setOpen(false),120)}
        onChange={e=>{setQ(e.target.value); onChange(e.target.value);}}/>
      {open && list.length>0 && (
        <div className="auto-list">
          {list.map((s,i)=><div key={i} className="auto-item" onMouseDown={()=>commit(s)}>{s}</div>)}
        </div>
      )}
    </div>
  );
}

/* ======= Movimientos ======= */
function Movimientos({data,save}){
  const rows=data.movimientos||[];
  function add(){ rows.push({objeto:"",entrada:nowHHMM(),salida:"",movimiento:"",a_cargo:""}); save({movimientos:[...rows]}); }
  function setRow(i,p){ rows[i]={...rows[i],...p}; save({movimientos:[...rows]}); }
  function del(i){ rows.splice(i,1); save({movimientos:[...rows]}); }
  return (
    <div>
      <div className="muted" style={{margin:'6px 0'}}>Novedades</div>
      <table><thead><tr>
        <th style="width:28%">Objeto</th><th style="width:14%">Entrada</th><th style="width:14%">Salida</th><th>Movimiento</th><th style="width:18%">A cargo</th><th style="width:40px"></th>
      </tr></thead>
      <tbody>
        {rows.map((r,i)=>(
          <tr key={i}>
            <td><AutoObjeto value={r.objeto} onChange={v=>setRow(i,{objeto:v})}/></td>
            <td><input value={r.entrada||nowHHMM()} onChange={e=>setRow(i,{entrada:e.target.value})}/></td>
            <td><input value={r.salida||""} onChange={e=>setRow(i,{salida:e.target.value})}/></td>
            <td><input value={r.movimiento||""} onChange={e=>setRow(i,{movimiento:e.target.value})}/></td>
            <td><input value={r.a_cargo||""} onChange={e=>setRow(i,{a_cargo:e.target.value})}/></td>
            <td><button className="btn danger" onClick={()=>del(i)}>‚úï</button></td>
          </tr>
        ))}
      </tbody></table>
      <div className="right" style="margin-top:8px"><button className="btn success" onClick={add}>Agregar fila</button></div>
    </div>
  );
}

/* ======= Poblaci√≥n ======= */
function Poblacion({data,save}){
  const rows=data.poblacionListado||[];
  const P=data.poblacion||{};
  const tot=rows.length;
  const condenados=rows.filter(r=>r.cp==='C').length;
  const procesados=rows.filter(r=>r.cp==='P').length;
  const mismatch= (P.total && Number(P.total)!==tot) || (P.condenados && Number(P.condenados)!==condenados) || (P.procesados && Number(P.procesados)!==procesados);

  function add(){ rows.push({matricula:"",cp:"C",nombre:""}); save({poblacionListado:[...rows]}); }
  function setRow(i,p){ rows[i]={...rows[i],...p}; save({poblacionListado:[...rows]}); }
  function del(i){ rows.splice(i,1); save({poblacionListado:[...rows]}); }

  return (
    <div>
      {mismatch && <div className="muted" style={{color:'#fbbf24',marginBottom:'6px'}}>Aviso: los totales no coinciden con el detalle.</div>}
      <table><thead><tr><th>Matr√≠cula</th><th>C/P</th><th>Apellido y Nombre</th><th style="width:40px"></th></tr></thead>
      <tbody>
        {rows.map((r,i)=>(
          <tr key={i}>
            <td><input value={r.matricula||""} onChange={e=>setRow(i,{matricula:e.target.value})}/></td>
            <td>
              <select value={r.cp||"C"} onChange={e=>setRow(i,{cp:e.target.value})}>
                <option value="C">C</option><option value="P">P</option>
              </select>
            </td>
            <td><input value={r.nombre||""} onChange={e=>setRow(i,{nombre:e.target.value})}/></td>
            <td><button className="btn danger" onClick={()=>del(i)}>‚úï</button></td>
          </tr>
        ))}
      </tbody></table>
      <div className="right" style="margin-top:8px"><button className="btn success" onClick={add}>Agregar interno</button></div>
    </div>
  );
}

/* ======= Notas m√≠nimas ======= */
function NotesScreen(){
  const [store,setStore]=useStoreCtx();
  const [type,setType]=useState('sueldo');
  const [date,setDate]=useState(ymd(new Date()));
  const [text,setText]=useState('');
  function add(){ const n=[...(store.notes||[]), {id:crypto.randomUUID?.()||String(Date.now()), type, date, text}]; setStore(s=>({...s,notes:n})); }
  function del(id){ setStore(s=>({...s, notes:(s.notes||[]).filter(x=>x.id!==id)})); }
  return (
    <div style={{padding:'12px',flex:1,overflow:'auto'}}>
      <div style={{display:'grid',gap:'8px',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',marginBottom:'10px'}}>
        <select value={type} onChange={e=>setType(e.target.value)}>
          <option value="sueldo">D√≠a de paga (sueldo)</option>
          <option value="pago_recargos">Pagos de recargos</option>
          <option value="art">ART N¬∫</option>
          <option value="licencia">Licencia (rango de d√≠as)</option>
          <option value="aguinaldo">Pago aguinaldo</option>
          <option value="texto">Texto a elecci√≥n</option>
        </select>
        <input type="date" value={date} onChange={e=>setDate(e.target.value)}/>
        <input placeholder="Detalle / n¬∫ / rango" value={text} onChange={e=>setText(e.target.value)}/>
        <button className="btn success" onClick={add}>Agregar</button>
      </div>
      <div style={{display:'grid',gap:'8px'}}>
        {(store.notes||[]).map(it=>(
          <div key={it.id} className="panel">
            <div className="panel-b" style="display:flex;gap:8px;align-items:flex-start">
              <div className="badge" style="background:#0ea5e9;text-transform:capitalize">{it.type}</div>
              <div style="flex:1">
                <div className="muted">{it.date}</div>
                <div>{it.text}</div>
              </div>
              <button className="btn danger" onClick={()=>del(it.id)}>‚úï</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ======= Ajustes ======= */
function SettingsModal({onClose}){
  const [store,setStore]=useStoreCtx();
  const [start,setStart]=useState(store.pattern.start||"");
  const [turno,setTurno]=useState(store.pattern.turno||"B");
  const [enabled,setEnabled]=useState(!!store.pattern.enabled);
  const [colors,setColors]=useState({...store.colors});
  const [holidaysTxt,setHolidaysTxt]=useState((store.holidays||[]).join("\n"));

  const duplicated=(()=>{const set=new Set();return ['guardia','recargo','art','licencia'].some(k=>{const v=colors[k]; if(set.has(v)) return true; set.add(v); return false;});})();

  function save(){
    const holidays=holidaysTxt.split(/\s+/).map(s=>s.trim()).filter(Boolean);
    setStore(s=>({...s,
      pattern:{...s.pattern,start,turno,enabled},
      colors:{...s.colors,...colors},
      holidays
    }));
    onClose();
  }

  return (
    <div className="modal" onClick={onClose}>
      <div className="card" onClick={e=>e.stopPropagation()}>
        <h3 style="margin:4px 0 10px">Ajustes</h3>
        <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
          <label className="l">Inicio patr√≥n (d√≠a guardia)<input type="date" value={start} onChange={e=>setStart(e.target.value)}/></label>
          <label className="l">Turno
            <select value={turno} onChange={e=>setTurno(e.target.value)}><option>A</option><option>B</option><option>C</option></select>
          </label>
          <label className="l">Patr√≥n 24√ó48 <input type="checkbox" checked={enabled} onChange={e=>setEnabled(e.target.checked)}/></label>

          <div style="grid-column:1/-1" className="muted">Colores por estado (sin repetir):</div>
          {['guardia','recargo','art','licencia'].map(k=>(
            <label className="l" key={k} style="text-transform:capitalize">{k}<input type="color" value={colors[k]} onChange={e=>setColors(c=>({...c,[k]:e.target.value}))}/></label>
          ))}
          <label className="l">Fondo patr√≥n guardia<input value={colors.patternGuardiaBg} onChange={e=>setColors(c=>({...c,patternGuardiaBg:e.target.value}))}/></label>
          <label className="l">Borde hoy<input type="color" value={colors.today} onChange={e=>setColors(c=>({...c,today:e.target.value}))}/></label>
          <label className="l">Selecci√≥n<input type="color" value={colors.selected} onChange={e=>setColors(c=>({...c,selected:e.target.value}))}/></label>

          {duplicated && <div style="grid-column:1/-1;color:#fbbf24" className="muted">Aviso: hay colores repetidos entre estados.</div>}

          <label className="l" style="grid-column:1/-1">Feriados (YYYY-MM-DD, uno por l√≠nea)
            <textarea rows="4" value={holidaysTxt} onChange={e=>setHolidaysTxt(e.target.value)}></textarea>
          </label>
        </div>

        <div className="right" style="margin-top:10px">
          <button className="btn" onClick={onClose}>Cerrar</button>
          <button className="btn success" onClick={save}>Guardar</button>
        </div>
      </div>
    </div>
  );
}

/* ======= Quick (long-press) ======= */
function QuickModal({ymdKey,data,onClose,onPick,onOpenLicencia}){
  const [estado,setEstado]=useState(data.estado||"");
  const [pago,setPago]=useState(!!data.pago);
  const [swap,setSwap]=useState(!!data.swap);
  const [linked,setLinked]=useState(data.linkedDate||"");
  const [artNum,setArtNum]=useState(data.artNumero||"");
  useEffect(()=>{ if(pago && swap){ setPago(false); }},[pago,swap]);

  function go(){
    if(estado==='licencia'){ onOpenLicencia(); return; }
    if(estado==='art'){ onPick({estado:'art',pago:false,swap:false,linkedDate:"",artNumero:artNum}); onClose(); return; }
    onPick({estado:estado||null,pago,swap,linkedDate: swap? linked:""});
    onClose();
  }

  return (
    <div className="modal" onClick={onClose}>
      <div className="card" onClick={e=>e.stopPropagation()}>
        <div className="muted" style="margin-bottom:8px">{ymdKey}</div>
        <div style="display:grid;gap:8px">
          <select value={estado} onChange={e=>setEstado(e.target.value)}>
            <option value="">(sin estado)</option>
            <option value="guardia">Guardia</option>
            <option value="recargo">Recargo</option>
            <option value="cubro_guardia">Cubro guardia a‚Ä¶</option>
            <option value="me_cubre_guardia">Me cubre guardia‚Ä¶</option>
            <option value="cubro_recargo">Cubro recargo a‚Ä¶</option>
            <option value="me_cubre_recargo">Me cubre recargo‚Ä¶</option>
            <option value="art">ART N¬∫‚Ä¶</option>
            <option value="licencia">Licencia‚Ä¶</option>
          </select>

          {estado==='art' && (
            <input placeholder="N¬∫ ART" value={artNum} onChange={e=>setArtNum(e.target.value)}/>
          )}

          {(estado && !['recargo','guardia','art','licencia'].includes(estado)) && (
            <input placeholder="Apellido/Nombre (qui√©n)" />
          )}

          <label className="l" style="flex-direction:row;align-items:center;gap:8px">
            <input type="checkbox" checked={pago} onChange={e=>{setPago(e.target.checked); if(e.target.checked) setSwap(false);}}/> üí≤
          </label>
          <label className="l" style="flex-direction:row;align-items:center;gap:8px">
            <input type="checkbox" checked={swap} onChange={e=>{setSwap(e.target.checked); if(e.target.checked) setPago(false);}}/> üîÑ
          </label>
          {swap && <input type="date" value={linked} onChange={e=>setLinked(e.target.value)}/>}

          <div className="right" style="margin-top:6px">
            <button className="btn" onClick={onClose}>Cancelar</button>
            <button className="btn success" onClick={go}>{estado==='licencia'?'Licencia‚Ä¶':'Guardar'}</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ======= Licencia ======= */
function LicenseModal({date,holidays,onClose,onApply}){
  const [mode,setMode]=useState('rango'); // rango | calculo
  const [hasta,setHasta]=useState("");
  const [corridos,setCorridos]=useState("");
  const [habiles,setHabiles]=useState("");
  const [excluirFeriados,setExcluirFeriados]=useState(true);

  return (
    <div className="modal" onClick={onClose}>
      <div className="card" onClick={e=>e.stopPropagation()}>
        <div style="margin-bottom:8px">Licencia desde <b>{date}</b></div>
        <div style="margin-bottom:8px">
          <label style="margin-right:12px"><input type="radio" name="m" checked={mode==='rango'} onChange={()=>setMode('rango')}/> Por rango</label>
          <label><input type="radio" name="m" checked={mode==='calculo'} onChange={()=>setMode('calculo')}/> Por d√≠as</label>
        </div>

        {mode==='rango' ? (
          <label className="l">Hasta<input type="date" value={hasta} onChange={e=>setHasta(e.target.value)}/></label>
        ) : (
          <div style="display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
            <label className="l">D√≠as corridos<input type="number" min="0" value={corridos} onChange={e=>setCorridos(e.target.value)}/></label>
            <label className="l">D√≠as h√°biles<input type="number" min="0" value={habiles} onChange={e=>setHabiles(e.target.value)}/></label>
            <label className="l" style="flex-direction:row;align-items:center;gap:8px"><input type="checkbox" checked={excluirFeriados} onChange={e=>setExcluirFeriados(e.target.checked)}/> Excluir feriados</label>
          </div>
        )}

        <div className="right" style="margin-top:10px">
          <button className="btn" onClick={onClose}>Cancelar</button>
          <button className="btn success" onClick={()=>onApply({mode,until:hasta,corridos,habiles,excluirFeriados})}>Aplicar</button>
        </div>
      </div>
    </div>
  );
}

/* ========= Montaje ========= */
function Root(){
  const storeHook=useStore();
  return <StoreCtx.Provider value={storeHook}><App/></StoreCtx.Provider>
}
ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>

<script>
// SW externo (no blobs) ‚Äî compatible con GitHub Pages
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(console.warn);
}
</script>
</body>
</html>
